<!DOCTYPE html>
<html lang="id">
<head>
	<title>Api Test</title>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta name="keywords" content="css, library, drax, draxcss, light">
	<meta name="description" content="An API tester">
	<link rel="stylesheet" href="/assets/drax.css">
	<style>
	.badge:after {
	width: auto;
    border-radius: 1.5em;
    font-size:.7em;
    padding:.2em .5em;
    background: inherit;
	}
	body:not(.mobile) .overflow-y {
    overflow-y: auto;
	}
	body:not(.mobile) .overflow-y:hover {
    -webkit-margin-end: 0;
}
    </style>
	<script src="/assets/vue.global.prod.js"></script>
</head>
<body>
	<div id="APP"class="p-4">
		<div class="row six-lg">
			<div class="fill">
				<h2>API Test <span class="small text-secondary"><small>v.0.2.0</small></span></h2>
			</div>
			<div class="text-right pt-3">
				<a href="/info.php" target="_blank">PHP INFO</a>
				-
				<a href="/adminer.php" target="_blank">ADMINER</a>
			</div>
		</div>
		<hr class="mt-0">
		<div class="row six-lg">

			<section class="collections border-bottom pr-3 pb-3">
				<v-text v-model="collections.search" class="small" placeholder="Collections"></v-text>

				<div class="small py-2">
					<div class="group small">
						<button class="secondary" @click="collections.filter=''">All</button>
						<button class="primary" @click="collections.filter='GET'">GET</button>
						<button class="success" @click="collections.filter='POST'">POST</button>
						<button class="warning" @click="collections.filter='PUT'">PUT</button>
						<button class="error" @click="collections.filter='DELETE'">DELETE</button>
					</div>

					<div class="group small">
						<button v-for="g in collections.group"
								@click="filterGroup(g)"
								:class="collections.groupFiltered.includes(g)?'maroon':'muted'">
							{{ g }}
						</button>
					</div>
				</div>


				<div class="overflow-y" style="max-height:80vh">
					<div v-for="mode,key in filteredCollections">
						<h4>{{key}}</h4>
						<div class="pl-2 border-left">
							<div v-for="col in mode" :data-tooltip="col.description">
								<template v-if="col.method=='separator'">
									<hr class="my-1">
								</template>
								<template v-else>
									<button :class="methodClass[col.method]+' small badge pr-5 mr-3'" @click="setForm(col)" :data-badge="col.method">
										{{ col.url.split('?')[0] }}
									</button>
								</template>
							</div>
						</div>
					</div>
				</div>

			</section>

			<div class="fill row one two-lg">
				<section class="form px-3 border-left" @keyup.enter="submit">
					<v-text v-model="baseurl" class="small" placeholder="Base URL"></v-text>
<!--
					<div class="secondary p-3" style="height:50px">{{ form.description }}</div>
-->
					<div class="row gap four">
						<div>
							<v-select v-model="form.method" :options="['GET','POST','PUT','DELETE']" placeholder="Method"></v-select>
						</div>
						<div class="fill">
							<v-text v-model="form.url" class="small" placeholder="URL"></v-text>
						</div>
					</div>

					<div class="border-bottom my-2"></div>
					<div v-show="!['GET','DELETE'].includes(form.method)" class="small border">
						<div class="row gap four">
							<span class="py-0">Type</span>
							<span class="py-0">Name</span>
							<span class="py-0">Value</span>
						</div>
						<div v-for="opt in form.options" class="row gap four">
							<v-select v-model="opt.type" :options="['text','file']" class="large"></v-select>
							<v-text v-model="opt.key"></v-text>
							<div class="fill">
								<v-text v-if="opt.type=='text'" v-model="opt.value"></v-text>
								<v-file v-else v-model="opt.value"></v-file>
							</div>

						</div>
					</div>
					<button v-if="loading" class="small muted">Loading ... </button>
					<template v-else>
						<button v-if="!form.external" class="small secondary" @click="submit">Send</button>
					</template>
					<a v-if="form.external" :href="form.url" class="button small" target="_blank">External</a>

					<hr>
					<button @click="prev=[]" class="maroon small">Reset Test</button>
					<pre class="small overflow-y" style="max-height:30vh;white-space:pre-wrap">{{ formRequest }}</pre>
				</section>


				<section class="result small pl-3 border-left">
					<div v-if="status" class="group large">
						<span :class="(status.ok ? 'info': 'error')+' label'">{{ status.status }}</span>
						<span :class="(status.ok ? 'info': 'error')+' label'">{{ status.statusText }}</span>
						&nbsp;
						&nbsp;
						<span :class="(status.ok ? 'info': 'error')+' label'">{{ status.time/1000 }} s</span>
					</div>
					<br>

					<label>Token</label>
					<textarea class="small">{{ token }}</textarea>

					<label>Firebase Token</label>
					<textarea class="small">{{ firebaseToken }}</textarea>

					<label>Header</label>
					<textarea class="small" style="height:150px">{{ header }}</textarea>
					<br>
					<label>Response</label>
					<button @click="asHtml=!asHtml" class="small">{{ asHtml?'HTML':'TEXT' }}</button>
					<div v-if="asHtml" v-html="response"></div>
					<textarea v-else class="small" style="height:300px">{{ response }}</textarea>
				</section>
			</div>

		</div>

	</div>

	<script src="/collections.js?v1"></script>
	<script>
		var baseurl = localStorage.getItem('baseurl');
		var groupFiltered = localStorage.getItem('groupFiltered');
		const app = Vue.createApp({
			data(){
				return {
					baseurl : baseurl?baseurl:'http://localhost',
					firebaseToken : null,
					status	: null,
					token : null,
					header : null,
					response: null,
					asHtml  : false,
					loading : false,
					prev	:[],
					form 	: {
						method :'GET',
						url :'',
						body:{},
						options : [
							{ type: 'text', key:'', value:''},
						]
					},
					methodClass:{
						'GET' : '',
						'POST' : 'success',
						'PUT' : 'warning',
						'DELETE' : 'error',
					},
					collections : {
						group	: Object.keys(collections),
						groupFiltered	: groupFiltered?JSON.parse(groupFiltered):Object.keys(collections),
						search 	: '',
						filter	: '',
						data	: collections
					}
				};
			},
			mounted(){
				setTimeout(()=>{
					this.firebaseMessagingToken();
				},3000);
			},
			watch:{
				'form.options':{
					handler(val){
						var body = {};
						var filled;
						val.forEach(opt=>{
							// console.log(opt.key.indexOf(':'));
							if(opt.key==''){
								filled = true;
							}
							else{
								body[opt.key] = opt.value;
							}
						});

						this.form.body = body;
						if(!filled){
							this.form.options.push({key:'',type:'text',value:''});
						}
					},
					deep:true
				},
				'collections.groupFiltered':{
					handler(val){
						localStorage.setItem('groupFiltered',JSON.stringify(val));
					}
				},
				baseurl(val){
					localStorage.setItem('baseurl', val);
				}
			},
			computed:{
				filteredCollections(){
					var obj = {};
					Object.keys(this.collections.data).forEach(key=>{
						if(this.collections.groupFiltered.includes(key)){
							var collections = this.collections.data[key];

							var isExists = d => {
								var searched = d.url.includes(this.collections.search);
								var filtered = d.method.includes(this.collections.filter);
								return searched && filtered;
							};
							obj[key] = collections.filter(isExists);
						}
					});
					return obj;
				},
				formRequest(){
					var form = Object.assign({}, this.form);
					delete form.options;
					return form;
				}
			},
			methods:{
				firebaseMessagingToken(){
					firebase.messaging().getToken().then(r=>{
						this.firebaseToken = r;
					});
				},
				filterGroup(name){
					// console.log(name);
					if(this.collections.groupFiltered.includes(name)){
						//remove
						this.collections.groupFiltered=this.collections.groupFiltered.filter(n=>n!=name);
					}else{
						//add
						this.collections.groupFiltered.push(name);
					}
				},
				setForm(collection){
					if(!collection.body){
						collection.body = {};
					}
					this.form = Object.assign({}, collection);

					if(this.form.url.indexOf(':prev')>-1){
						path = this.form.url.split(':prev.');
						this.form.url = path[0] + path[1].split('.').reduce((p,c)=>p&&p[c]||null, this.prev);
					}

//					console.log(this.form.url);
					var options = Object.keys(collection.body).map(key=>{
						if(key.indexOf(':file')>-1){
							var type = 'file';
							key = key.replace(':file','');
						}else{
							var type = 'text';
						}
						value = collection.body[key];
						if( typeof value == 'string'){
							if(value.indexOf(':prev')>-1){
								path = value.split(':prev.')[1];
								value = path.split('.').reduce((p,c)=>p&&p[c]||null, this.prev);
							}
						}
						return {type:type, key:key, value:value};
					});
					this.form.options = options;
				},
				setData(form){
					var formData = new FormData();
					Object.keys(form).forEach(name=>{
						var value = form[name];
						if(typeof value !=='undefined' && value !='undefined'){
							formData.append(name,value)
						}
					})
					return formData;
				},
				submit(){
					var time = new Date().getTime();
					this.loading = true;
					var form = Object.assign({},this.form);
					if(['GET','DELETE'].includes(form.method)){
						// form.url += '?' + (new URLSearchParams(form.body)).toString();
						body	= null;
					}else{
						body	= this.setData(form.body);
					}
					if(form.url.indexOf('logout')>-1){
						//this.token = ''
					}
					fetch(this.baseurl + form.url,{
						method	: form.method,
						body	: body,
						headers	: {Authorization : 'Bearer '+ this.token}
					}).then(status=>{
						// console.log(status)
						var headers = {};
						status.headers.forEach((value, key)=>{
							headers[key] = value;
						});
						status.time = new Date().getTime() - time;
						this.status = status;
						this.header = headers;
						if(status.headers.has('jwt')){
							this.token = status.headers.get('jwt');
						}
						if (status.ok) {
							return status.text();
						}else{
							return status.text().then(err => Promise.reject(err));
						}
					}).then(response=>{
						try{
							var resp = JSON.parse(response);
						}catch(e){
							resp = response;
						}
						this.prev.push(resp);
						this.response = resp;
					}).catch(error=>{
						try{
							var resp = JSON.parse(error);
						}catch(e){
							resp = error;
						}
						this.response = resp;
						// console.log(error);
					}).finally(_=>{
						this.loading = false;
					})

				}
			}
		});
	</script>
	<script src="/assets/base.js"></script>

	<script src="https://www.gstatic.com/firebasejs/8.3.0/firebase-app.js"></script>

	<script src="https://www.gstatic.com/firebasejs/8.3.0/firebase-messaging.js"></script>
	<script src="./firebase-init.js"></script>
	<script>
		let messaging;
		// navigator.serviceWorker.register('./firebase-messaging-sw.js')
		// .then((registration) => {
		   // firebase.messaging().useServiceWorker(registration);
		// });
		if('serviceWorker' in navigator) {
			navigator.serviceWorker.register('./firebase-messaging-sw.js')
			.then(function(registration) {
				console.log("Service Worker Registered");
				firebase.messaging().useServiceWorker(registration);
			});
        }
		messaging = firebase.messaging();
		messaging.onMessage((payload) => {
		  console.log('Message received. ', payload);
		  // ...
		});
		const APP = app.mount('#APP');
	</script>
</body>
</html>
